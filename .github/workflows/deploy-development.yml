name: Deploy to Development

# Trigger on push to develop branch or manual workflow dispatch
on:
  push:
    branches:
      - develop
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to Development Server
    runs-on: self-hosted  # Self-hosted runner on development server
    environment: development

    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Set environment variables
        run: |
          echo "COMPOSE_PROJECT_NAME=leopard-dev" >> $GITHUB_ENV
          echo "DEPLOYMENT_TIME=$(date +'%Y-%m-%d %H:%M:%S')" >> $GITHUB_ENV

      - name: Copy .env file from parent directory (if exists)
        run: |
          if [ -f ../.env ]; then
            cp ../.env .env
            echo "✓ .env file copied from parent directory"
          elif [ -f .env ]; then
            echo "✓ .env file already exists"
          else
            echo "Warning: .env file not found, using defaults"
          fi

      - name: Check database container status
        id: db_status
        run: |
          echo "Checking database container status..."
          if docker-compose -f docker-compose.dev.yml ps postgres 2>/dev/null | grep -q "Up.*healthy"; then
            echo "status=healthy" >> $GITHUB_OUTPUT
            echo "✓ Database is running and healthy"
          elif docker-compose -f docker-compose.dev.yml ps postgres 2>/dev/null | grep -q "Up"; then
            echo "status=running" >> $GITHUB_OUTPUT
            echo "⚠ Database is running but not yet healthy"
          else
            echo "status=stopped" >> $GITHUB_OUTPUT
            echo "Database is not running"
          fi

      - name: Detect changed services
        id: changes
        run: |
          echo "Detecting which services have changed..."
          
          # For manual workflow dispatch, always build all services
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "build_backend=true" >> $GITHUB_OUTPUT
            echo "build_frontend=true" >> $GITHUB_OUTPUT
            echo "✓ Manual trigger - building all services"
            exit 0
          fi
          
          # Get the commit range (previous commit to current)
          # For push events, use github.event.before if available, otherwise use HEAD~1
          if [ -n "${{ github.event.before }}" ] && [ "${{ github.event.before }}" != "0000000000000000000000000000000000000000" ]; then
            BEFORE="${{ github.event.before }}"
          else
            # Fallback: use previous commit (might be first push to branch)
            BEFORE=$(git rev-parse HEAD~1 2>/dev/null || echo "")
            if [ -z "$BEFORE" ]; then
              echo "build_backend=true" >> $GITHUB_OUTPUT
              echo "build_frontend=true" >> $GITHUB_OUTPUT
              echo "✓ First commit on branch - building all services"
              exit 0
            fi
          fi
          AFTER="${{ github.sha }}"
          
          # Check for changes in each service directory
          BACKEND_CHANGED=false
          FRONTEND_CHANGED=false
          
          # Check backend changes
          if git diff --name-only "$BEFORE" "$AFTER" -- backend/ docker-compose.dev.yml | grep -q .; then
            BACKEND_CHANGED=true
            echo "✓ Backend changes detected"
          fi
          
          # Check frontend changes
          if git diff --name-only "$BEFORE" "$AFTER" -- frontend/ docker-compose.dev.yml | grep -q .; then
            FRONTEND_CHANGED=true
            echo "✓ Frontend changes detected"
          fi
          
          # Also check root-level files that affect all services
          if git diff --name-only "$BEFORE" "$AFTER" -- .env .github/workflows/ | grep -q .; then
            BACKEND_CHANGED=true
            FRONTEND_CHANGED=true
            echo "✓ Root-level changes detected - building all services"
          fi
          
          # Set output variables
          echo "build_backend=$BACKEND_CHANGED" >> $GITHUB_OUTPUT
          echo "build_frontend=$FRONTEND_CHANGED" >> $GITHUB_OUTPUT
          
          # Summary
          echo "=== Build Plan ==="
          echo "Backend: $BACKEND_CHANGED"
          echo "Frontend: $FRONTEND_CHANGED"

      - name: Build Docker images (conditional)
        run: |
          echo "Building development Docker images (conditional based on changes)..."
          echo "Building before stopping containers to avoid unnecessary downtime on failure"
          
          SERVICES_TO_BUILD=""
          
          if [ "${{ steps.changes.outputs.build_backend }}" = "true" ]; then
            SERVICES_TO_BUILD="$SERVICES_TO_BUILD backend"
            echo "✓ Will build backend"
          fi
          
          if [ "${{ steps.changes.outputs.build_frontend }}" = "true" ]; then
            SERVICES_TO_BUILD="$SERVICES_TO_BUILD frontend"
            echo "✓ Will build frontend"
          fi
          
          if [ -z "$SERVICES_TO_BUILD" ]; then
            echo "⚠ No services need rebuilding - no changes detected"
            echo "skip_build=true" >> $GITHUB_ENV
          else
            echo "Building services:$SERVICES_TO_BUILD"
            docker-compose -f docker-compose.dev.yml build --pull $SERVICES_TO_BUILD
            echo "skip_build=false" >> $GITHUB_ENV
          fi

      - name: Stop existing containers (conditional)
        if: env.skip_build != 'true'
        run: |
          echo "Build succeeded, stopping affected containers..."
          # Only stop application containers, keep database running if it's healthy
          if [ "${{ steps.db_status.outputs.status }}" = "healthy" ]; then
            echo "Database is healthy, stopping only affected application containers..."
            
            SERVICES_TO_STOP=""
            if [ "${{ steps.changes.outputs.build_backend }}" = "true" ]; then
              SERVICES_TO_STOP="$SERVICES_TO_STOP backend"
            fi
            if [ "${{ steps.changes.outputs.build_frontend }}" = "true" ]; then
              SERVICES_TO_STOP="$SERVICES_TO_STOP frontend"
            fi
            
            if [ -n "$SERVICES_TO_STOP" ]; then
              docker-compose -f docker-compose.dev.yml stop $SERVICES_TO_STOP || true
            else
              echo "No services to stop"
            fi
          else
            echo "Stopping all containers..."
            docker-compose -f docker-compose.dev.yml down || true
          fi

      - name: Start all containers (conditional)
        if: env.skip_build != 'true'
        run: |
          echo "Starting affected containers..."
          
          SERVICES_TO_START=""
          if [ "${{ steps.changes.outputs.build_backend }}" = "true" ]; then
            SERVICES_TO_START="$SERVICES_TO_START backend"
          fi
          if [ "${{ steps.changes.outputs.build_frontend }}" = "true" ]; then
            SERVICES_TO_START="$SERVICES_TO_START frontend"
          fi
          
          if [ -n "$SERVICES_TO_START" ]; then
            echo "Starting services:$SERVICES_TO_START"
            docker-compose -f docker-compose.dev.yml up -d $SERVICES_TO_START
          else
            echo "No services to start"
          fi
          
          # Always ensure all services are up (in case some weren't rebuilt but need to be running)
          echo "Ensuring all services are running..."
          docker-compose -f docker-compose.dev.yml up -d

      - name: Ensure services running (no changes detected)
        if: env.skip_build == 'true'
        run: |
          echo "No changes detected - ensuring all services are running..."
          docker-compose -f docker-compose.dev.yml up -d
          echo "✓ All services verified running"

      - name: Wait for database to be healthy
        run: |
          echo "Waiting for database to be healthy (using docker-compose healthcheck)..."
          docker-compose -f docker-compose.dev.yml wait postgres || {
            echo "Error: Database failed to become healthy"
            docker-compose -f docker-compose.dev.yml logs postgres
            exit 1
          }
          echo "✓ Database is healthy"

      - name: Run database migrations
        if: env.skip_build != 'true' && steps.changes.outputs.build_backend == 'true'
        run: |
          echo "Running database migrations..."
          sleep 10
          docker-compose -f docker-compose.dev.yml exec -T backend python manage.py migrate --noinput
          echo "✓ Migrations completed"

      - name: Health check - Backend
        if: env.skip_build != 'true' && steps.changes.outputs.build_backend == 'true'
        run: |
          echo "Checking backend health..."
          sleep 5
          if docker-compose -f docker-compose.dev.yml exec -T backend curl -f http://localhost:8000/api/v1/health/; then
            echo "✓ Backend health check passed"
          else
            echo "Warning: Backend health check failed"
            docker-compose -f docker-compose.dev.yml logs backend
          fi

      - name: Verify container status
        run: |
          echo "=== Development Container Status ==="
          docker-compose -f docker-compose.dev.yml ps

      - name: Clean up Docker resources
        run: |
          echo "Cleaning up unused Docker resources..."
          docker system prune -f

      - name: Display deployment summary
        run: |
          echo "======================================"
          echo "Development deployment completed!"
          echo "======================================"
          echo "Environment: development"
          echo "Time: $DEPLOYMENT_TIME"
          echo "Commit: $(git rev-parse --short HEAD)"
          echo
          echo "Access URLs:"
          echo "  Backend API: http://localhost:8000/api/"
          echo "  Frontend: http://localhost:5173"
          echo "  Database: localhost:5432"
          echo
          echo "To view logs:"
          echo "  docker-compose -f docker-compose.dev.yml logs -f backend"
          echo "  docker-compose -f docker-compose.dev.yml logs -f frontend"

      - name: Deployment notification
        if: always()
        run: |
          if [ "${{ job.status }}" = "success" ]; then
            echo "✓ Development deployment successful"
          else
            echo "✗ Development deployment failed"
          fi
