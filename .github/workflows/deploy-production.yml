name: Deploy to Production

# Trigger on push to main branch or manual workflow dispatch
on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      skip_tests:
        description: 'Skip tests before deployment'
        required: false
        type: boolean
        default: false

jobs:
  deploy:
    name: Deploy to Production Server
    runs-on: self-hosted  # Self-hosted runner on production server
    environment: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # Fetch all history for proper git operations

      - name: Set environment variables
        run: |
          echo "COMPOSE_PROJECT_NAME=leopard" >> $GITHUB_ENV
          echo "USE_HTTPS=True" >> $GITHUB_ENV
          echo "DEPLOYMENT_TIME=$(date +'%Y-%m-%d %H:%M:%S')" >> $GITHUB_ENV

      - name: Copy .env file from parent directory
        run: |
          if [ -f ../.env ]; then
            cp ../.env .env
            echo "✓ .env file copied from parent directory"
          elif [ -f .env ]; then
            echo "✓ .env file already exists in working directory"
          else
            echo "Error: .env file not found!"
            echo "Please create .env file at: $(pwd)/../.env"
            echo "Expected location: $HOME/actions-runner/_work/leopard/.env"
            exit 1
          fi

      - name: Verify .env file exists
        run: |
          if [ ! -f .env ]; then
            echo "Error: .env file not found after copy!"
            exit 1
          fi
          echo "✓ .env file verified"
          echo "Environment variables loaded:"
          grep -v "PASSWORD\|SECRET" .env | head -5

      - name: Check database container status
        id: db_status
        run: |
          echo "Checking database container status..."
          if docker-compose ps postgres 2>/dev/null | grep -q "Up.*healthy"; then
            echo "status=healthy" >> $GITHUB_OUTPUT
            echo "✓ Database is running and healthy"
          elif docker-compose ps postgres 2>/dev/null | grep -q "Up"; then
            echo "status=running" >> $GITHUB_OUTPUT
            echo "⚠ Database is running but not yet healthy"
          else
            echo "status=stopped" >> $GITHUB_OUTPUT
            echo "Database is not running"
          fi

      - name: Detect changed services
        id: changes
        run: |
          echo "Detecting which services have changed..."
          
          # For manual workflow dispatch, always build all services
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "build_backend=true" >> $GITHUB_OUTPUT
            echo "build_frontend=true" >> $GITHUB_OUTPUT
            echo "build_nginx=true" >> $GITHUB_OUTPUT
            echo "✓ Manual trigger - building all services"
            exit 0
          fi
          
          # Get the commit range (previous commit to current)
          # For push events, use github.event.before if available, otherwise use HEAD~1
          if [ -n "${{ github.event.before }}" ] && [ "${{ github.event.before }}" != "0000000000000000000000000000000000000000" ]; then
            BEFORE="${{ github.event.before }}"
          else
            # Fallback: use previous commit (might be first push to branch)
            BEFORE=$(git rev-parse HEAD~1 2>/dev/null || echo "")
            if [ -z "$BEFORE" ]; then
              echo "build_backend=true" >> $GITHUB_OUTPUT
              echo "build_frontend=true" >> $GITHUB_OUTPUT
              echo "build_nginx=true" >> $GITHUB_OUTPUT
              echo "✓ First commit on branch - building all services"
              exit 0
            fi
          fi
          AFTER="${{ github.sha }}"
          
          # Check for changes in each service directory
          BACKEND_CHANGED=false
          FRONTEND_CHANGED=false
          NGINX_CHANGED=false
          
          # Check backend changes
          if git diff --name-only "$BEFORE" "$AFTER" -- backend/ docker-compose.yml docker-compose.dev.yml | grep -q .; then
            BACKEND_CHANGED=true
            echo "✓ Backend changes detected"
          fi
          
          # Check frontend changes
          if git diff --name-only "$BEFORE" "$AFTER" -- frontend/ docker-compose.yml docker-compose.dev.yml | grep -q .; then
            FRONTEND_CHANGED=true
            echo "✓ Frontend changes detected"
          fi
          
          # Check nginx changes
          if git diff --name-only "$BEFORE" "$AFTER" -- nginx/ docker-compose.yml docker-compose.dev.yml | grep -q .; then
            NGINX_CHANGED=true
            echo "✓ Nginx changes detected"
          fi
          
          # Also check root-level files that affect all services
          if git diff --name-only "$BEFORE" "$AFTER" -- .env .github/workflows/ | grep -q .; then
            BACKEND_CHANGED=true
            FRONTEND_CHANGED=true
            NGINX_CHANGED=true
            echo "✓ Root-level changes detected - building all services"
          fi
          
          # Set output variables
          echo "build_backend=$BACKEND_CHANGED" >> $GITHUB_OUTPUT
          echo "build_frontend=$FRONTEND_CHANGED" >> $GITHUB_OUTPUT
          echo "build_nginx=$NGINX_CHANGED" >> $GITHUB_OUTPUT
          
          # Summary
          echo "=== Build Plan ==="
          echo "Backend: $BACKEND_CHANGED"
          echo "Frontend: $FRONTEND_CHANGED"
          echo "Nginx: $NGINX_CHANGED"

      - name: Build Docker images (conditional)
        run: |
          echo "Building Docker images (conditional based on changes)..."
          echo "Building before stopping containers to avoid unnecessary downtime on failure"
          
          SERVICES_TO_BUILD=""
          
          if [ "${{ steps.changes.outputs.build_backend }}" = "true" ]; then
            SERVICES_TO_BUILD="$SERVICES_TO_BUILD backend"
            echo "✓ Will build backend"
          fi
          
          if [ "${{ steps.changes.outputs.build_frontend }}" = "true" ]; then
            SERVICES_TO_BUILD="$SERVICES_TO_BUILD frontend"
            echo "✓ Will build frontend"
          fi
          
          if [ "${{ steps.changes.outputs.build_nginx }}" = "true" ]; then
            SERVICES_TO_BUILD="$SERVICES_TO_BUILD nginx"
            echo "✓ Will build nginx"
          fi
          
          if [ -z "$SERVICES_TO_BUILD" ]; then
            echo "⚠ No services need rebuilding - no changes detected"
            echo "skip_build=true" >> $GITHUB_ENV
          else
            echo "Building services:$SERVICES_TO_BUILD"
            docker-compose build --no-cache --pull $SERVICES_TO_BUILD
            echo "skip_build=false" >> $GITHUB_ENV
          fi

      - name: Stop existing containers (conditional)
        if: env.skip_build != 'true'
        run: |
          echo "Build succeeded, stopping affected containers..."
          # Only stop application containers, keep database running if it's healthy
          if [ "${{ steps.db_status.outputs.status }}" = "healthy" ]; then
            echo "Database is healthy, stopping only affected application containers..."
            
            SERVICES_TO_STOP=""
            if [ "${{ steps.changes.outputs.build_backend }}" = "true" ]; then
              SERVICES_TO_STOP="$SERVICES_TO_STOP backend"
            fi
            if [ "${{ steps.changes.outputs.build_frontend }}" = "true" ]; then
              SERVICES_TO_STOP="$SERVICES_TO_STOP frontend"
            fi
            if [ -n "$SERVICES_TO_STOP" ]; then
              docker-compose stop $SERVICES_TO_STOP || true
            else
              echo "No services to stop"
            fi
          else
            echo "Stopping all containers..."
            docker-compose down || true
          fi

      - name: Start database container (if needed)
        if: steps.db_status.outputs.status != 'healthy'
        run: |
          echo "Starting PostgreSQL database..."
          docker-compose up -d postgres

      - name: Wait for database to be healthy
        if: steps.db_status.outputs.status != 'healthy'
        run: |
          echo "Waiting for database to be healthy..."
          timeout=60
          elapsed=0
          while [ $elapsed -lt $timeout ]; do
            # Check if postgres container is healthy using docker inspect
            if docker inspect --format='{{.State.Health.Status}}' $(docker-compose ps -q postgres) 2>/dev/null | grep -q "healthy"; then
              echo "✓ Database is healthy"
              exit 0
            fi
            # Also check with pg_isready as fallback
            if docker-compose exec -T postgres pg_isready -U ${DB_USER:-leopard} >/dev/null 2>&1; then
              echo "✓ Database is ready (pg_isready check)"
              exit 0
            fi
            echo "Waiting for database... ($elapsed/$timeout seconds)"
            sleep 2
            elapsed=$((elapsed+2))
          done
          echo "Error: Database failed to become healthy within $timeout seconds"
          docker-compose logs postgres
          exit 1

      - name: Start all containers (conditional with force recreate)
        if: env.skip_build != 'true'
        run: |
          echo "Starting affected containers with new images..."
          
          SERVICES_TO_START=""
          if [ "${{ steps.changes.outputs.build_backend }}" = "true" ]; then
            SERVICES_TO_START="$SERVICES_TO_START backend"
          fi
          if [ "${{ steps.changes.outputs.build_frontend }}" = "true" ]; then
            SERVICES_TO_START="$SERVICES_TO_START frontend"
          fi
          if [ -n "$SERVICES_TO_START" ]; then
            echo "Starting services with force recreate:$SERVICES_TO_START"
            # Force recreate to ensure new images are used (without --no-deps to handle dependencies)
            docker-compose up -d --force-recreate $SERVICES_TO_START
          else
            echo "No services to start"
          fi
          
          # Always ensure all services are up (in case some weren't rebuilt but need to be running)
          echo "Ensuring all services are running..."
          docker-compose up -d

      - name: Check and start services (no changes detected)
        if: env.skip_build == 'true'
        run: |
          echo "No changes detected - checking service status and starting if needed..."
          
          # Check which services are not running or don't exist
          SERVICES_TO_START=""
          
          # Check backend (container exists and is running)
          if ! docker-compose ps backend 2>/dev/null | grep -qE "(Up|running)"; then
            SERVICES_TO_START="$SERVICES_TO_START backend"
            echo "Backend is down or doesn't exist, will start"
          fi
          
          # Check frontend (container exists and is running)
          if ! docker-compose ps frontend 2>/dev/null | grep -qE "(Up|running)"; then
            SERVICES_TO_START="$SERVICES_TO_START frontend"
            echo "Frontend is down or doesn't exist, will start"
          fi
          
          # Check nginx (container exists and is running)
          if ! docker-compose ps nginx 2>/dev/null | grep -qE "(Up|running)"; then
            SERVICES_TO_START="$SERVICES_TO_START nginx"
            echo "Nginx is down or doesn't exist, will start"
          fi
          
          # Check database
          if [ "${{ steps.db_status.outputs.status }}" != "healthy" ]; then
            SERVICES_TO_START="postgres $SERVICES_TO_START"
            echo "Database is down or not healthy, will start"
          fi
          
          if [ -n "$SERVICES_TO_START" ]; then
            echo "Starting services:$SERVICES_TO_START"
            docker-compose up -d $SERVICES_TO_START
            
            # Wait for database if we started it
            if echo "$SERVICES_TO_START" | grep -q "postgres"; then
              echo "Waiting for database to be healthy..."
              timeout=60
              elapsed=0
              while [ $elapsed -lt $timeout ]; do
                if docker inspect --format='{{.State.Health.Status}}' $(docker-compose ps -q postgres) 2>/dev/null | grep -q "healthy"; then
                  echo "✓ Database is healthy"
                  break
                fi
                if docker-compose exec -T postgres pg_isready -U ${DB_USER:-leopard} >/dev/null 2>&1; then
                  echo "✓ Database is ready"
                  break
                fi
                echo "Waiting for database... ($elapsed/$timeout seconds)"
                sleep 2
                elapsed=$((elapsed+2))
              done
              if [ $elapsed -ge $timeout ]; then
                echo "Warning: Database did not become healthy, but continuing..."
              fi
            fi
          else
            echo "✓ All services are already running"
          fi
          
          # Final check - ensure all services are up
          docker-compose up -d
          echo "✓ All services verified running"

      - name: Wait for backend initialization
        if: env.skip_build != 'true' && steps.changes.outputs.build_backend == 'true'
        run: |
          echo "Waiting for backend to complete initialization (migrations, collectstatic)..."
          sleep 30
          echo "Backend should now be ready"

      - name: Wait for services to be healthy
        if: env.skip_build != 'true'
        run: |
          echo "Waiting for all services to be healthy..."
          sleep 30
          docker-compose ps

          # Check if backend is healthy (only if backend was rebuilt)
          if [ "${{ steps.changes.outputs.build_backend }}" = "true" ]; then
            if ! docker-compose ps | grep -q "leopard-backend.*Up"; then
              echo "Backend container is not healthy! Showing logs..."
              docker-compose logs --tail=100 backend
              exit 1
            fi
          fi

      - name: Health check - Backend
        if: env.skip_build != 'true' && steps.changes.outputs.build_backend == 'true'
        run: |
          echo "Checking backend health..."
          max_attempts=10
          attempt=1
          while [ $attempt -le $max_attempts ]; do
            if docker-compose exec -T backend curl -f http://localhost:8000/health/; then
              echo "✓ Backend health check passed"
              break
            fi
            echo "Attempt $attempt/$max_attempts failed, retrying..."
            sleep 5
            attempt=$((attempt+1))
          done
          if [ $attempt -gt $max_attempts ]; then
            echo "Error: Backend health check failed"
            docker-compose logs backend
            exit 1
          fi

      - name: Health check - Frontend (via nginx)
        if: env.skip_build != 'true' && (steps.changes.outputs.build_frontend == 'true' || steps.changes.outputs.build_nginx == 'true')
        run: |
          echo "Checking frontend accessibility via nginx..."
          # Wait for nginx to be ready
          sleep 10
          if curl -k -f https://localhost/ > /dev/null 2>&1 || curl -f http://localhost/ > /dev/null 2>&1; then
            echo "✓ Frontend accessible"
          else
            echo "Warning: Frontend health check failed (may be normal if SSL not yet configured)"
            docker-compose logs nginx
            docker-compose logs frontend
          fi

      - name: Verify container status
        run: |
          echo "=== Container Status ==="
          docker-compose ps
          echo
          echo "=== Container Health ==="
          docker ps --format "table {{.Names}}\t{{.Status}}"

      - name: Clean up Docker resources
        run: |
          echo "Cleaning up unused Docker resources..."
          docker system prune -f
          echo "✓ Cleanup completed"

      - name: Display deployment summary
        run: |
          echo "======================================"
          echo "Deployment completed successfully!"
          echo "======================================"
          echo "Environment: production"
          echo "Time: $DEPLOYMENT_TIME"
          echo "Commit: $(git rev-parse --short HEAD)"
          echo "Branch: $(git branch --show-current)"
          echo
          echo "Container status:"
          docker-compose ps
          echo
          echo "To view logs:"
          echo "  docker-compose logs -f backend"
          echo "  docker-compose logs -f frontend"
          echo "  docker-compose logs -f nginx"

      - name: Deployment notification
        if: always()
        run: |
          if [ "${{ job.status }}" = "success" ]; then
            echo "✓ Deployment successful"
          else
            echo "✗ Deployment failed"
          fi

      # Optional: Send notification (uncomment and configure)
      # - name: Send Slack notification
      #   if: always()
      #   uses: 8398a7/action-slack@v3
      #   with:
      #     status: ${{ job.status }}
      #     text: 'Production deployment ${{ job.status }}'
      #     webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}
