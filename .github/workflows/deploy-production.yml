name: Deploy to Production

# Trigger on push to main branch or manual workflow dispatch
on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      skip_tests:
        description: 'Skip tests before deployment'
        required: false
        type: boolean
        default: false

jobs:
  deploy:
    name: Deploy to Production Server
    runs-on: self-hosted  # Self-hosted runner on production server
    environment: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # Fetch all history for proper git operations

      - name: Set environment variables
        run: |
          echo "DJANGO_ENV=production" >> $GITHUB_ENV
          echo "COMPOSE_PROJECT_NAME=leopard" >> $GITHUB_ENV
          echo "DEPLOYMENT_TIME=$(date +'%Y-%m-%d %H:%M:%S')" >> $GITHUB_ENV

      - name: Copy .env file from parent directory
        run: |
          if [ -f ../.env ]; then
            cp ../.env .env
            echo "✓ .env file copied from parent directory"
          elif [ -f .env ]; then
            echo "✓ .env file already exists in working directory"
          else
            echo "Error: .env file not found!"
            echo "Please create .env file at: $(pwd)/../.env"
            echo "Expected location: $HOME/actions-runner/_work/leopard/.env"
            exit 1
          fi

      - name: Verify .env file exists
        run: |
          if [ ! -f .env ]; then
            echo "Error: .env file not found after copy!"
            exit 1
          fi
          echo "✓ .env file verified"
          echo "Environment variables loaded:"
          grep -v "PASSWORD\|SECRET" .env | head -5

      - name: Stop existing containers
        run: |
          echo "Stopping existing containers..."
          docker-compose down || true

      - name: Build Docker images
        run: |
          echo "Building Docker images (this may take several minutes)..."
          docker-compose build --no-cache --pull

      - name: Start database container
        run: |
          echo "Starting PostgreSQL database..."
          docker-compose up -d postgres

      - name: Wait for database to be healthy
        run: |
          echo "Waiting for database to be ready..."
          timeout=60
          while [ $timeout -gt 0 ]; do
            if docker-compose exec -T postgres pg_isready -U ${DB_USER:-leopard}; then
              echo "✓ Database is ready"
              break
            fi
            echo "Waiting for database... ($timeout seconds remaining)"
            sleep 2
            timeout=$((timeout-2))
          done
          if [ $timeout -le 0 ]; then
            echo "Error: Database failed to start"
            docker-compose logs postgres
            exit 1
          fi

      - name: Run database migrations
        run: |
          echo "Running database migrations..."
          docker-compose up -d backend
          sleep 10
          docker-compose exec -T backend python manage.py migrate --noinput
          echo "✓ Migrations completed"

      - name: Collect static files
        run: |
          echo "Collecting static files..."
          docker-compose exec -T backend python manage.py collectstatic --noinput
          echo "✓ Static files collected"

      - name: Start all containers
        run: |
          echo "Starting all containers..."
          docker-compose up -d

      - name: Wait for services to be healthy
        run: |
          echo "Waiting for all services to be healthy..."
          sleep 30
          docker-compose ps

      - name: Health check - Backend
        run: |
          echo "Checking backend health..."
          max_attempts=10
          attempt=1
          while [ $attempt -le $max_attempts ]; do
            if docker-compose exec -T backend curl -f http://localhost:8000/api/v1/health/; then
              echo "✓ Backend health check passed"
              break
            fi
            echo "Attempt $attempt/$max_attempts failed, retrying..."
            sleep 5
            attempt=$((attempt+1))
          done
          if [ $attempt -gt $max_attempts ]; then
            echo "Error: Backend health check failed"
            docker-compose logs backend
            exit 1
          fi

      - name: Health check - Frontend (via nginx)
        run: |
          echo "Checking frontend accessibility via nginx..."
          # Wait for nginx to be ready
          sleep 10
          if curl -k -f https://localhost/ > /dev/null 2>&1 || curl -f http://localhost/ > /dev/null 2>&1; then
            echo "✓ Frontend accessible"
          else
            echo "Warning: Frontend health check failed (may be normal if SSL not yet configured)"
            docker-compose logs nginx
            docker-compose logs frontend
          fi

      - name: Verify container status
        run: |
          echo "=== Container Status ==="
          docker-compose ps
          echo
          echo "=== Container Health ==="
          docker ps --format "table {{.Names}}\t{{.Status}}"

      - name: Clean up Docker resources
        run: |
          echo "Cleaning up unused Docker resources..."
          docker system prune -f
          echo "✓ Cleanup completed"

      - name: Display deployment summary
        run: |
          echo "======================================"
          echo "Deployment completed successfully!"
          echo "======================================"
          echo "Environment: production"
          echo "Time: $DEPLOYMENT_TIME"
          echo "Commit: $(git rev-parse --short HEAD)"
          echo "Branch: $(git branch --show-current)"
          echo
          echo "Container status:"
          docker-compose ps
          echo
          echo "To view logs:"
          echo "  docker-compose logs -f backend"
          echo "  docker-compose logs -f frontend"
          echo "  docker-compose logs -f nginx"

      - name: Deployment notification
        if: always()
        run: |
          if [ "${{ job.status }}" = "success" ]; then
            echo "✓ Deployment successful"
          else
            echo "✗ Deployment failed"
          fi

      # Optional: Send notification (uncomment and configure)
      # - name: Send Slack notification
      #   if: always()
      #   uses: 8398a7/action-slack@v3
      #   with:
      #     status: ${{ job.status }}
      #     text: 'Production deployment ${{ job.status }}'
      #     webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}
