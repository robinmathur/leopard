"""
Django management command to seed the database with test data.

Usage:
    python manage.py seed_data [--clear]

Options:
    --clear: Clear existing data before seeding
"""

import random
import time
from datetime import datetime, timedelta
from decimal import Decimal

from django.core.management.base import BaseCommand
from django.db import transaction
from django.contrib.auth import get_user_model
from django.contrib.auth.models import Group
from django.db.models.signals import post_save, pre_save
from django.dispatch import receiver

from immigration.models import Tenant, Region, Branch
from immigration.client.client import Client
from immigration.visa.visa_category import VisaCategory
from immigration.visa.visa_type import VisaType
from immigration.visa.visa_application import VisaApplication
from immigration.models.agent import Agent
from immigration.task import Task
from immigration.constants import (
    ClientStage,
    AgentType,
    TaskPriority,
    TaskStatus,
)

User = get_user_model()


class Command(BaseCommand):
    help = 'Seed database with realistic test data for development and testing'

    def add_arguments(self, parser):
        parser.add_argument(
            '--clear',
            action='store_true',
            help='Clear existing data before seeding',
        )

    def handle(self, *args, **options):
        start_time = time.time()
        
        self.stdout.write(self.style.WARNING('ðŸŒ± Starting database seeding...'))
        
        if options['clear']:
            self.stdout.write(self.style.WARNING('âš ï¸  Clearing existing data...'))
            self.clear_data()
        
        try:
            # Temporarily disable signals that expect middleware context
            from immigration import signals as immigration_signals
            post_save.disconnect(immigration_signals.client_events, sender=Client)
            post_save.disconnect(immigration_signals.visa_application_events, sender=VisaApplication)
            
            with transaction.atomic():
                # Seed in order of dependencies
                tenants = self.seed_tenants()
                regions = self.seed_regions(tenants)
                branches = self.seed_branches(regions)
                users = self.seed_users(tenants, regions, branches)
                visa_categories = self.seed_visa_categories(users[0])
                visa_types = self.seed_visa_types(visa_categories, users[0])
                agents = self.seed_agents(users[0])
                clients = self.seed_clients(branches, users, visa_categories, agents)
                applications = self.seed_applications(clients, visa_types, users)
                
                elapsed = time.time() - start_time
            
            # Tasks are part of User Story 3 - may not exist yet (outside transaction so it doesn't rollback)
            tasks = []
            try:
                tasks = self.seed_tasks(users, clients)
            except Exception as e:
                self.stdout.write(self.style.WARNING(f'  âš   Skipping tasks (User Story 3 not implemented): {str(e)}'))
            
            # Re-enable signals
            post_save.connect(immigration_signals.client_events, sender=Client)
            post_save.connect(immigration_signals.visa_application_events, sender=VisaApplication)
            
            self.stdout.write(self.style.SUCCESS(f'\nâœ… Database seeded successfully in {elapsed:.2f} seconds!'))
            self.stdout.write(self.style.SUCCESS(f'\nðŸ“Š Summary:'))
            self.stdout.write(f'  â€¢ Tenants: {len(tenants)}')
            self.stdout.write(f'  â€¢ Regions: {len(regions)}')
            self.stdout.write(f'  â€¢ Branches: {len(branches)}')
            self.stdout.write(f'  â€¢ Users: {len(users)}')
            self.stdout.write(f'  â€¢ Visa Categories: {len(visa_categories)}')
            self.stdout.write(f'  â€¢ Visa Types: {len(visa_types)}')
            self.stdout.write(f'  â€¢ Agents: {len(agents)}')
            self.stdout.write(f'  â€¢ Clients: {len(clients)}')
            self.stdout.write(f'  â€¢ Visa Applications: {len(applications)}')
            self.stdout.write(f'  â€¢ Tasks: {len(tasks)}')
                
        except Exception as e:
            self.stdout.write(self.style.ERROR(f'\nâŒ Error seeding database: {str(e)}'))
            raise

    def clear_data(self):
        """Clear existing test data."""
        # Clear in reverse dependency order
        try:
            Task.objects.all().delete()
        except Exception:
            pass  # Task model from User Story 3 may not exist yet
        
        VisaApplication.objects.all().delete()
        Client.objects.all().delete()
        Agent.objects.all().delete()
        VisaType.objects.all().delete()
        VisaCategory.objects.all().delete()
        User.objects.filter(is_superuser=False).delete()
        Branch.objects.all().delete()
        Region.objects.all().delete()
        Tenant.objects.all().delete()
        self.stdout.write(self.style.SUCCESS('  âœ“ Existing data cleared'))

    def seed_tenants(self):
        """Create tenant organizations."""
        self.stdout.write('Creating tenants...')
        
        tenant_data = [
            {
                'name': 'Global Immigration Services',
                'domain': 'globalimmigration.com',
                'is_active': True,
                'subscription_status': 'ACTIVE',
                'settings': {'timezone': 'UTC', 'language': 'en'}
            },
            {
                'name': 'Visa Express Solutions',
                'domain': 'visaexpress.com',
                'is_active': True,
                'subscription_status': 'ACTIVE',
                'settings': {'timezone': 'America/New_York', 'language': 'en'}
            },
            {
                'name': 'Migration Partners Ltd',
                'domain': 'migrationpartners.com',
                'is_active': True,
                'subscription_status': 'TRIAL',
                'settings': {'timezone': 'Europe/London', 'language': 'en'}
            },
        ]
        
        tenants = []
        for data in tenant_data:
            tenant = Tenant.objects.create(**data)
            tenants.append(tenant)
            self.stdout.write(f'  âœ“ Created tenant: {tenant.name}')
        
        return tenants

    def seed_regions(self, tenants):
        """Create regions for each tenant."""
        self.stdout.write('Creating regions...')
        
        regions_data = {
            'Global Immigration Services': ['North America', 'Europe', 'Asia Pacific'],
            'Visa Express Solutions': ['East Coast', 'West Coast'],
            'Migration Partners Ltd': ['UK & Ireland', 'Continental Europe'],
        }
        
        regions = []
        for tenant in tenants:
            region_names = regions_data.get(tenant.name, ['Region 1', 'Region 2'])
            for name in region_names:
                region = Region.objects.create(
                    tenant=tenant,
                    name=name,
                    description=f'{name} region for {tenant.name}'
                )
                regions.append(region)
                self.stdout.write(f'  âœ“ Created region: {region.name} ({tenant.name})')
        
        return regions

    def seed_branches(self, regions):
        """Create branch offices."""
        self.stdout.write('Creating branches...')
        
        branch_templates = [
            ('Downtown Office', '123 Main St', 'Downtown', 'NY', '10001', '+1-555-0100'),
            ('Midtown Branch', '456 Park Ave', 'Midtown', 'NY', '10022', '+1-555-0200'),
            ('Airport Office', '789 Airport Rd', 'Queens', 'NY', '11430', '+1-555-0300'),
        ]
        
        branches = []
        for region in regions:
            # Create 2 branches per region
            for i in range(2):
                template = branch_templates[i % len(branch_templates)]
                branch = Branch.objects.create(
                    tenant=region.tenant,
                    region=region,
                    name=f'{region.name} - {template[0]}',
                    phone=template[5],
                    website=f'https://{region.tenant.domain}',
                    street=template[1],
                    suburb=template[2],
                    state=template[3],
                    postcode=template[4],
                )
                branches.append(branch)
                self.stdout.write(f'  âœ“ Created branch: {branch.name}')
        
        return branches

    def seed_users(self, tenants, regions, branches):
        """Create users with different roles."""
        self.stdout.write('Creating users...')
        
        users = []
        
        # Super Super Admin (system-wide)
        super_super_admin = User.objects.create_user(
            username='superadmin',
            email='superadmin@system.com',
            password='password123',
            first_name='Super',
            last_name='Admin',
            role=UserRole.SUPER_SUPER_ADMIN.value,
            is_staff=True,
        )
        users.append(super_super_admin)
        self.stdout.write(f'  âœ“ Created Super Super Admin: {super_super_admin.username}')
        
        # Create users for each tenant
        for tenant in tenants:
            # Super Admin (tenant-wide)
            super_admin = User.objects.create_user(
                username=f'admin_{tenant.name[:10].lower().replace(" ", "_")}',
                email=f'admin@{tenant.domain}',
                password='password123',
                first_name='Tenant',
                last_name='Administrator',
                role=UserRole.SUPER_ADMIN.value,
                tenant=tenant,
            )
            users.append(super_admin)
            self.stdout.write(f'  âœ“ Created Super Admin: {super_admin.username}')
            
            # Country Manager
            country_mgr = User.objects.create_user(
                username=f'country_{tenant.name[:10].lower().replace(" ", "_")}',
                email=f'country@{tenant.domain}',
                password='password123',
                first_name='Country',
                last_name='Manager',
                role=UserRole.COUNTRY_MANAGER.value,
                tenant=tenant,
            )
            users.append(country_mgr)
            self.stdout.write(f'  âœ“ Created Country Manager: {country_mgr.username}')
        
        # Create regional and branch users
        for region in regions:
            # Region Manager
            region_mgr = User.objects.create_user(
                username=f'region_{region.name[:15].lower().replace(" ", "_").replace("&", "and")}',
                email=f'region.{region.name.lower().replace(" ", ".")}@{region.tenant.domain}',
                password='password123',
                first_name='Regional',
                last_name='Manager',
                role=UserRole.REGION_MANAGER.value,
                tenant=region.tenant,
                region=region,
            )
            users.append(region_mgr)
            self.stdout.write(f'  âœ“ Created Region Manager: {region_mgr.username}')
        
        # Create branch-level users
        for branch in branches:
            # Branch Admin
            branch_admin = User.objects.create_user(
                username=f'branch_{branch.id}',
                email=f'branch.{branch.id}@{branch.tenant.domain}',
                password='password123',
                first_name='Branch',
                last_name='Administrator',
                role=UserRole.BRANCH_ADMIN.value,
                tenant=branch.tenant,
                region=branch.region,
                branch=branch,
            )
            users.append(branch_admin)
            
            # 2-3 Consultants per branch
            for i in range(random.randint(2, 3)):
                consultant = User.objects.create_user(
                    username=f'consultant_{branch.id}_{i+1}',
                    email=f'consultant{i+1}.branch{branch.id}@{branch.tenant.domain}',
                    password='password123',
                    first_name=random.choice(['John', 'Jane', 'Michael', 'Sarah', 'David', 'Emma']),
                    last_name=random.choice(['Smith', 'Johnson', 'Williams', 'Brown', 'Jones', 'Garcia']),
                    role=UserRole.CONSULTANT.value,
                    tenant=branch.tenant,
                    region=branch.region,
                    branch=branch,
                )
                users.append(consultant)
            
            self.stdout.write(f'  âœ“ Created branch users for: {branch.name}')
        
        return users

    def seed_visa_categories(self, created_by):
        """Create visa categories."""
        self.stdout.write('Creating visa categories...')
        
        categories_data = [
            ('Work Visa', 'WORK', 'Employment-based visa programs'),
            ('Student Visa', 'STUDENT', 'Education and training visas'),
            ('Permanent Residence', 'PR', 'Permanent residency programs'),
            ('Family Visa', 'FAMILY', 'Family reunion and sponsorship'),
            ('Visitor Visa', 'VISITOR', 'Tourist and temporary visitor visas'),
            ('Business Visa', 'BUSINESS', 'Business and investor visas'),
        ]
        
        categories = []
        for name, code, desc in categories_data:
            category = VisaCategory.objects.create(
                name=name,
                created_by=created_by,
            )
            categories.append(category)
            self.stdout.write(f'  âœ“ Created visa category: {category.name}')
        
        return categories

    def seed_visa_types(self, categories, created_by):
        """Create specific visa types under categories."""
        self.stdout.write('Creating visa types...')
        
        visa_types_data = {
            'Work Visa': [
                ('Skilled Independent', '189', 500, 2000),
                ('Employer Sponsored', '482', 1200, 1500),
                ('Regional Sponsored', '494', 400, 1800),
            ],
            'Student Visa': [
                ('Student', '500', 620, 800),
                ('Guardian', '590', 565, 700),
            ],
            'Permanent Residence': [
                ('Skilled Independent PR', '189', 4115, 3000),
                ('Family Sponsored PR', '864', 4155, 2500),
            ],
            'Family Visa': [
                ('Partner Visa', '820', 7715, 2000),
                ('Parent Visa', '103', 4155, 2500),
            ],
            'Visitor Visa': [
                ('Visitor', '600', 145, 500),
                ('ETA', '601', 20, 200),
            ],
            'Business Visa': [
                ('Business Innovation', '188A', 5375, 3500),
                ('Investor', '188B', 8445, 4000),
            ],
        }
        
        visa_types = []
        for category in categories:
            types_data = visa_types_data.get(category.name, [])
            for visa_type_name, sub_class, imm_fee, service_fee in types_data:
                visa_type = VisaType.objects.create(
                    visa_type=visa_type_name,
                    sub_class=sub_class,
                    immigration_fee=imm_fee,
                    visa_service_fee=service_fee,
                    visa_category=category,
                    checklist=[
                        'Identity documents',
                        'Passport',
                        'Photos',
                        'Financial evidence',
                        'Health examination',
                    ],
                    created_by=created_by,
                )
                visa_types.append(visa_type)
            
            if types_data:
                self.stdout.write(f'  âœ“ Created {len(types_data)} types for: {category.name}')
        
        return visa_types

    def seed_agents(self, created_by):
        """Create external agents."""
        self.stdout.write('Creating agents...')
        
        agents_data = [
            ('Global Migration Associates', 'SUPER_AGENT', '+1-555-1000', 'contact@globalmigration.com'),
            ('Visa Partners Network', 'SUPER_AGENT', '+1-555-2000', 'info@visapartners.com'),
            ('Regional Consultancy Services', 'SUB_AGENT', '+1-555-3000', 'hello@regionalconsult.com'),
            ('Education Visa Specialists', 'SUB_AGENT', '+1-555-4000', 'team@eduvisa.com'),
            ('Family Migration Experts', 'SUB_AGENT', '+1-555-5000', 'support@familymigration.com'),
        ]
        
        agents = []
        for name, agent_type, phone, email in agents_data:
            agent = Agent.objects.create(
                agent_name=name,
                agent_type=agent_type,
                phone_number=phone,
                email=email,
                website=f'https://{name.lower().replace(" ", "")}.com',
                street=f'{random.randint(100, 999)} Business St',
                suburb='Business District',
                state='NY',
                postcode='10001',
                country='US',
                created_by=created_by,
            )
            agents.append(agent)
            self.stdout.write(f'  âœ“ Created agent: {agent.agent_name}')
        
        return agents

    def seed_clients(self, branches, users, visa_categories, agents):
        """Create client records."""
        self.stdout.write('Creating clients (this may take a moment)...')
        
        first_names = ['John', 'Jane', 'Michael', 'Sarah', 'David', 'Emma', 'James', 'Emily', 
                       'Robert', 'Lisa', 'William', 'Maria', 'Richard', 'Jennifer', 'Thomas', 'Patricia']
        last_names = ['Smith', 'Johnson', 'Williams', 'Brown', 'Jones', 'Garcia', 'Miller', 'Davis',
                     'Rodriguez', 'Martinez', 'Hernandez', 'Lopez', 'Gonzalez', 'Wilson', 'Anderson']
        
        # Get consultants for assignment
        consultants = [u for u in users if u.role == UserRole.CONSULTANT.value]
        
        clients = []
        target_count = 60  # Create 60 clients for good test data
        
        for i in range(target_count):
            # Randomly select branch
            branch = random.choice(branches)
            
            # Get consultants from this branch
            branch_consultants = [u for u in consultants if u.branch_id == branch.id]
            assigned_to = random.choice(branch_consultants) if branch_consultants else None
            
            # Random client data
            first_name = random.choice(first_names)
            last_name = random.choice(last_names)
            
            client = Client.objects.create(
                first_name=first_name,
                last_name=last_name,
                middle_name=random.choice(['', 'A', 'B', 'C', 'D']) if random.random() > 0.5 else '',
                gender=random.choice(['MALE', 'FEMALE']),
                dob=datetime.now().date() - timedelta(days=random.randint(8000, 18000)),  # 22-49 years old
                phone_number=f'+1-555-{random.randint(6000, 9999)}',
                email=f'{first_name.lower()}.{last_name.lower()}@email.com',
                street=f'{random.randint(1, 999)} {random.choice(["Main", "Oak", "Pine", "Maple"])} St',
                suburb=random.choice(['Downtown', 'Midtown', 'Uptown', 'Suburbs']),
                state=random.choice(['NY', 'CA', 'TX', 'FL', 'IL']),
                postcode=f'{random.randint(10000, 99999)}',
                country=random.choice(['US', 'GB', 'CA', 'AU', 'IN', 'CN']),
                visa_category=random.choice(visa_categories) if random.random() > 0.2 else None,
                agent=random.choice(agents) if random.random() > 0.6 else None,
                assigned_to=assigned_to,
                stage=random.choice(['LEAD', 'FOLLOW_UP', 'CLIENT', 'CLOSE']),
                active=random.random() > 0.3,  # 70% active
                description=f'Client interested in {random.choice(["work", "study", "family", "business"])} visa',
                # Note: branch field doesn't exist in current Client model - multi-tenant refactoring pending
                created_by=assigned_to or branch_consultants[0] if branch_consultants else users[0],
            )
            clients.append(client)
            
            if (i + 1) % 20 == 0:
                self.stdout.write(f'  âœ“ Created {i + 1}/{target_count} clients...')
        
        self.stdout.write(self.style.SUCCESS(f'  âœ“ Created {len(clients)} clients'))
        return clients

    def seed_applications(self, clients, visa_types, users):
        """Create visa applications."""
        self.stdout.write('Creating visa applications...')
        
        applications = []
        
        # Create applications for ~60% of clients
        for client in random.sample(clients, int(len(clients) * 0.6)):
            # Some clients may have multiple applications
            num_applications = random.choices([1, 2, 3], weights=[70, 25, 5])[0]
            
            for _ in range(num_applications):
                visa_type = random.choice(visa_types)
                status = random.choice(['TO_BE_APPLIED', 'VISA_APPLIED', 'CASE_OPENED', 'GRANTED', 'REJECTED'])
                
                submission_date = None
                decision_date = None
                
                if status != 'TO_BE_APPLIED':
                    submission_date = datetime.now().date() - timedelta(days=random.randint(1, 180))
                    
                    if status in ['GRANTED', 'REJECTED']:
                        decision_date = submission_date + timedelta(days=random.randint(30, 120))
                
                application = VisaApplication.objects.create(
                    client=client,
                    visa_type=visa_type,
                    status=status,
                    date_applied=submission_date,
                    date_granted=decision_date if status == 'GRANTED' else None,
                    date_rejected=decision_date if status == 'REJECTED' else None,
                    assigned_to=client.assigned_to,
                    immigration_fee=visa_type.immigration_fee,
                    service_fee=visa_type.visa_service_fee,
                    notes=f'Application for {visa_type.visa_type} ({visa_type.sub_class})',
                    created_by=client.assigned_to or users[0],
                )
                applications.append(application)
        
        self.stdout.write(f'  âœ“ Created {len(applications)} visa applications')
        return applications

    def seed_tasks(self, users, clients):
        """Create tasks for users."""
        self.stdout.write('Creating tasks...')
        
        task_templates = [
            ('Follow up with client', 'Contact client regarding application status'),
            ('Review documents', 'Review and verify submitted documents'),
            ('Prepare application', 'Prepare visa application package'),
            ('Schedule interview', 'Schedule visa interview appointment'),
            ('Submit application', 'Submit completed application to authorities'),
            ('Document collection', 'Collect required supporting documents'),
            ('Client meeting', 'Meeting to discuss visa options'),
            ('Application review', 'Internal review of application materials'),
        ]
        
        tasks = []
        consultants = [u for u in users if u.role == UserRole.CONSULTANT.value]
        
        # Create 3-5 tasks per consultant
        for consultant in consultants:
            # Get clients assigned to this consultant
            consultant_clients = [c for c in clients if c.assigned_to_id == consultant.id]
            
            num_tasks = random.randint(3, 5)
            for _ in range(num_tasks):
                title, detail = random.choice(task_templates)
                
                due_date = datetime.now().date() + timedelta(days=random.randint(-7, 30))
                
                task = Task.objects.create(
                    title=title,
                    detail=detail,
                    priority=random.choice([TaskPriority.LOW.value, TaskPriority.MEDIUM.value, TaskPriority.HIGH.value]),
                    due_date=due_date,
                    assigned_to=consultant,
                    status=random.choice([TaskStatus.PENDING.value, TaskStatus.COMPLETED.value, TaskStatus.CANCELLED.value]),
                    created_by=consultant,
                )
                tasks.append(task)
        
        self.stdout.write(f'  âœ“ Created {len(tasks)} tasks')
        return tasks
