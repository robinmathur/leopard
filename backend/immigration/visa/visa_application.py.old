from django.db import models

from django.contrib.auth import get_user_model
from django.db.models import Count
from djmoney.models.fields import MoneyField
from rest_framework import serializers, status
from rest_framework.decorators import action
from rest_framework.response import Response

from immigration import constants
from immigration.client.client import Client
from immigration.constants import RESOURCE_MAPPING
from immigration.models import LifeCycleModel
from immigration.serializer import LifeCycleAwareSerializer, ForeignKeySerializer, HumanReadableIdAwareSerializer
from immigration.views import LifeCycleViewSet
from immigration.visa.visa_type import VisaType

User = get_user_model()


class VisaApplication(LifeCycleModel):
    VISA_STATUS = [
        ('TO_BE_APPLIED', 'To be Applied'),
        ('VISA_APPLIED', 'Visa Applied'),
        ('CASE_OPENED', 'Case Opened'),
        ('GRANTED', 'Granted'),
        ('REJECTED', 'Rejected'),
        ('WITHDRAWN', 'Withdrawn'),
    ]

    client = models.ForeignKey(Client, on_delete=models.CASCADE)
    visa_type = models.ForeignKey(VisaType, on_delete=models.PROTECT)
    transaction_reference_no = models.CharField(max_length=150, blank=True, null=True)
    immigration_fee = MoneyField(max_digits=10, decimal_places=2, default_currency='USD')
    service_fee = MoneyField(max_digits=10, decimal_places=2, default_currency='USD')
    dependent = models.BooleanField(default=False)
    notes = models.TextField(blank=True, null=True)
    assigned_to = models.ForeignKey(User, on_delete=models.SET_NULL, null=True, blank=True)
    required_documents = models.JSONField(default=list)  # This will store the list of required documents based on the VisaType checklist

    expiry_date = models.DateField(null=True, blank=True)
    date_applied = models.DateField(null=True, blank=True)
    date_opened = models.DateField(null=True, blank=True)
    final_date = models.DateField(null=True, blank=True)
    date_granted = models.DateField(null=True, blank=True)
    date_rejected = models.DateField(null=True, blank=True)
    date_withdrawn = models.DateField(null=True, blank=True)

    status = models.CharField(max_length=20, choices=VISA_STATUS, default='TO_BE_APPLIED')

    def __str__(self):
        return f"{self.client} - {self.visa_type} - {self.transaction_reference_no}"


class ClientBasicDetailSerializer(serializers.ModelSerializer):
    name = serializers.CharField(source='first_name', read_only=True)
    type = serializers.SerializerMethodField()

    class Meta:
        model = Client
        fields = ['id', 'name', 'type', 'email', 'phone_number']

    def to_internal_value(self, data):
        return Client.objects.get(id=data['id'])

    def get_type(self, obj):
        return RESOURCE_MAPPING.get_forward(type(obj).__name__)


class VisaApplicationBaseSerializer(LifeCycleAwareSerializer, HumanReadableIdAwareSerializer):
    visa_type = ForeignKeySerializer(queryset=VisaType.objects.all(), required=False)
    assigned_to = ForeignKeySerializer(queryset=User.objects.all(), required=False)

    class Meta:
        model = VisaApplication
        fields = '__all__'

    def get_entity_initial(self):
        return constants.IdPrefix.AGENT

    def validate(self, data):
        # During creation (POST), enforce that certain fields are required
        if self.instance is None:
            if not data.get('client'):
                raise serializers.ValidationError("Client is a required field.")
            if not data.get('visa_type'):
                raise serializers.ValidationError("Visa Type is a required field.")
            if not data.get('immigration_fee'):
                raise serializers.ValidationError("Immigration Fee is a required field.")
            if not data.get('service_fee'):
                raise serializers.ValidationError("Service Fee is a required field.")
            if not data.get('dependent'):
                raise serializers.ValidationError("Dependent is a required field.")
            # Validate status
            if 'status' in data and data['status'] not in dict(VisaApplication.VISA_STATUS):
                raise serializers.ValidationError("Invalid status value.")
        return data


class VisaApplicationSerializer(VisaApplicationBaseSerializer):
    client = ClientBasicDetailSerializer()


class VisaApplicationClientSerializer(VisaApplicationBaseSerializer):
    client = ForeignKeySerializer(queryset=Client.objects.all(), required=False)


class VisaApplicationViewSet(LifeCycleViewSet):
    queryset = VisaApplication.objects.all()
    serializer_class = VisaApplicationSerializer

    @action(detail=True, methods=['get'])
    def get_visa_applications_for_client(self, request, pk=None):
        # Filter visas by the given client ID (pk)
        visas = self.queryset.filter(client_id=pk)
        serializer = VisaApplicationClientSerializer(visas, many=True)
        return Response(serializer.data, status=status.HTTP_200_OK)

    @action(detail=False, methods=['get'], url_path='status-summary')
    def status_summary(self, request):
        visa_count = VisaApplication.objects.values('status').annotate(count=Count('status'))
        return Response(visa_count, status=status.HTTP_200_OK)
