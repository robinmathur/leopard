from django.db import models
from djmoney.models.fields import MoneyField
from rest_framework import status
from rest_framework.response import Response

from immigration import constants
from immigration.models import LifeCycleModel

from immigration.serializer import LifeCycleAwareSerializer, HumanReadableIdAwareSerializer, ForeignKeySerializer
from immigration.views import LifeCycleViewSet
from immigration.visa.visa_category import VisaCategory
from rest_framework.decorators import action


class VisaType(LifeCycleModel):
    visa_type = models.CharField(max_length=50)
    sub_class = models.CharField(max_length=50)
    immigration_fee = MoneyField(max_digits=10, decimal_places=2, default_currency='USD')
    visa_service_fee = MoneyField(max_digits=10, decimal_places=2, default_currency='USD')
    checklist = models.JSONField(default=list)
    visa_category = models.ForeignKey(VisaCategory, on_delete=models.CASCADE)

    def __str__(self):
        return f"{self.visa_type} - {self.sub_class}"


class VisaTypeSerializer(LifeCycleAwareSerializer, HumanReadableIdAwareSerializer):
    visa_category = ForeignKeySerializer(queryset=VisaCategory.objects.all(), required=False)
    class Meta:
        model = VisaType
        fields = '__all__'

    def get_entity_initial(self):
        return constants.IdPrefix.VISA_TYPE


class VisaTypeViewSet(LifeCycleViewSet):
    queryset = VisaType.objects.all()
    serializer_class = VisaTypeSerializer

    @action(detail=True, methods=['get'], url_path='visa-types')
    def get_visa_types_for_visa_category(self, request, pk=None):
        # Filter visa_types by the given visa category ID (pk)
        visa_types = self.queryset.filter(visa_category_id=pk)
        serializer = self.get_serializer(visa_types, many=True)
        return Response(serializer.data, status=status.HTTP_200_OK)
