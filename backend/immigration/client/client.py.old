from django.contrib.contenttypes.models import ContentType
from django.db import models
from django.db.models import Count
from django_countries.fields import CountryField
from django_softdelete.models import SoftDeleteModel
from rest_framework.decorators import action
from rest_framework.response import Response

from immigration.models.agent import Agent
from immigration.client.history.history_manager import HistoryManager
from immigration.constants import Gender
from immigration.models import LifeCycleModel
from immigration.reminder.reminder import ReminderCreateSerializer, Reminder, ReminderSerializer
from immigration.visa.visa_category import VisaCategory
from immigration.serializer import DeleteAwareSerializer, HumanReadableIdAwareSerializer, LifeCycleAwareSerializer, \
    ForeignKeySerializer
from immigration.views import LifeCycleViewSet

from immigration import pagination, constants

from rest_framework import filters, serializers, status
from rest_framework_simplejwt.authentication import JWTAuthentication
from django.contrib.auth import get_user_model
from django_filters.rest_framework import DjangoFilterBackend

User = get_user_model()


class Client(LifeCycleModel, SoftDeleteModel):
    first_name = models.CharField(max_length=100)
    middle_name = models.CharField(max_length=100, blank=True)
    last_name = models.CharField(max_length=100, blank=True)
    gender = models.CharField(max_length=6, choices=Gender.choices())
    dob = models.DateField(blank=True, null=True)
    phone_number = models.CharField(max_length=15, blank=True)
    email = models.EmailField(blank=True)
    # passport_no = models.CharField(max_length=20, blank=True)
    referred_by = models.CharField(max_length=20, blank=True)
    street = models.CharField(max_length=20, blank=True)
    suburb = models.CharField(max_length=20, blank=True)
    state = models.CharField(max_length=20, blank=True)
    postcode = models.CharField(max_length=20, blank=True)
    country = CountryField()
    visa_category = models.ForeignKey(VisaCategory, on_delete=models.SET_NULL, related_name="visa_category", blank=True,
                                      null=True)
    agent = models.ForeignKey(Agent, on_delete=models.SET_NULL, related_name="agent", blank=True, null=True)
    description = models.TextField(blank=True)

    assigned_to = models.ForeignKey(User, on_delete=models.SET_NULL, related_name="assigned_to", blank=True, null=True)
    stage = models.CharField(max_length=20, choices=constants.ClientStage.choices(), blank=True)
    active = models.BooleanField(default=False)

    class Meta:
        verbose_name = "client"

    def __str__(self):
        return f'{self.first_name} {self.last_name}'


# #############################################################################
#  Client Serializer
class ClientSerializer(DeleteAwareSerializer, HumanReadableIdAwareSerializer, LifeCycleAwareSerializer):
    agent = ForeignKeySerializer(queryset=Agent.objects.all(), required=False)
    visa_category = ForeignKeySerializer(queryset=VisaCategory.objects.all(), required=False)
    assigned_to = ForeignKeySerializer(queryset=User.objects.all(), required=False)
    country = serializers.CharField(required=False, allow_blank=True)

    class Meta(DeleteAwareSerializer.Meta, LifeCycleAwareSerializer.Meta):
        model = Client

    def get_entity_initial(self):
        return constants.IdPrefix.CLIENT


class ClientViewSet(LifeCycleViewSet):
    serializer_class = ClientSerializer
    queryset = Client.objects.all()
    authentication_classes = [JWTAuthentication]
    pagination_class = pagination.ClientPageNumberPagination
    filter_backends = (filters.SearchFilter, filters.OrderingFilter, DjangoFilterBackend)
    filterset_fields = ['stage', 'active']
    search_fields = ["first_name", "last_name", "email"]
    ordering_fields = ["id", "created_at", "first_name", "active"]
    ordering = ["-id"]

    @action(detail=False, methods=['get'], url_path='stage-summary')
    def stage_summary(self, request):
        # Group by stage and count the number of clients in each stage
        counts = Client.objects.values('stage').annotate(count=Count('id'))

        # Format the response data
        response_data = [
            {'stage': stage['stage'], 'count': stage['count']}
            for stage in counts
        ]

        return Response(response_data)

    @action(detail=True, methods=['post'], url_path='create-reminder')
    def create_reminder(self, request, pk=None):
        client = self.get_object()  # Get the client instance
        serializer = ReminderCreateSerializer(data=request.data)

        if serializer.is_valid():
            reminder = serializer.save(
                content_type=ContentType.objects.get_for_model(Client),
                object_id=client.id,
                created_by=request.user
            )
            client_history = client.history
            client_history.entries.append(HistoryManager.reminder_note_added(reminder.title, reminder.reminder_date))
            client_history.save()
            # TODO: send client history along in response
            return Response({'reminder': ReminderSerializer(reminder).data}, status=status.HTTP_201_CREATED)
        else:
            return Response(serializer.errors, status=status.HTTP_400_BAD_REQUEST)

    @action(detail=True, methods=['get'], url_path='reminders')
    def list_reminders(self, request, pk=None):
        reminders = Reminder.objects.filter(
            content_type=ContentType.objects.get_for_model(Client),
            object_id=pk
        )
        serializer = ReminderSerializer(reminders, many=True)
        return Response(serializer.data, status=status.HTTP_200_OK)
